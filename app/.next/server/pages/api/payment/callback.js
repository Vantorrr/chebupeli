"use strict";(()=>{var t={};t.id=323,t.ids=[323],t.modules={145:t=>{t.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9648:t=>{t.exports=import("axios")},6249:(t,e)=>{Object.defineProperty(e,"l",{enumerable:!0,get:function(){return function t(e,r){return r in e?e[r]:"then"in e&&"function"==typeof e.then?e.then(e=>t(e,r)):"function"==typeof e&&"default"===r?e:void 0}}})},8197:(t,e,r)=>{r.a(t,async(t,a)=>{try{r.r(e),r.d(e,{config:()=>u,default:()=>c,routeModule:()=>l});var s=r(1802),o=r(7153),d=r(6249),i=r(4123),n=t([i]);i=(n.then?(await n)():n)[0];let c=(0,d.l)(i,"default"),u=(0,d.l)(i,"config"),l=new s.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/payment/callback",pathname:"/api/payment/callback",bundlePath:"",filename:""},userland:i});a()}catch(t){a(t)}})},2714:(t,e,r)=>{r.a(t,async(t,a)=>{try{r.d(e,{z:()=>d});var s=r(9648),o=t([s]);s=(o.then?(await o)():o)[0];class i{constructor(t,e){this.merchantId=t,this.apiKey=e,this.api=s.default.create({baseURL:"https://api.mobimatter.com/mobimatter",headers:{merchantId:t,"api-key":e,"Content-Type":"application/json"}}),this.api.interceptors.request.use(t=>(console.log("MobiMatter API Request:",{method:t.method?.toUpperCase(),url:t.url,baseURL:t.baseURL}),t),t=>(console.error("MobiMatter API Request Error:",t),Promise.reject(t))),this.api.interceptors.response.use(t=>(console.log("MobiMatter API Response:",{status:t.status,url:t.config.url,dataLength:JSON.stringify(t.data).length}),t),t=>(console.error("MobiMatter API Response Error:",{status:t.response?.status,statusText:t.response?.statusText,url:t.config?.url,data:t.response?.data,message:t.message}),Promise.reject(t)))}async getProducts(t){try{let e=await this.api.get("/api/v2/products",{params:t}),r=typeof e.data,a=Array.isArray(e.data),s=e.data&&"object"==typeof e.data&&!Array.isArray(e.data)?Object.keys(e.data):[];if(console.log("MobiMatter getProducts response:",{status:e.status,dataType:r,isArray:a,keys:s.slice(0,10),dataLength:JSON.stringify(e.data).length,firstChars:JSON.stringify(e.data).substring(0,100)}),e.data.result&&Array.isArray(e.data.result))return console.log(`Получено ${e.data.result.length} продуктов (response.data.result)`),e.data.result;if(Array.isArray(e.data))return console.log(`Получено ${e.data.length} продуктов (массив)`),e.data;if(e.data.products&&Array.isArray(e.data.products))return console.log(`Получено ${e.data.products.length} продуктов (response.data.products)`),e.data.products;if(e.data.data&&Array.isArray(e.data.data))return console.log(`Получено ${e.data.data.length} продуктов (response.data.data)`),e.data.data;else return console.warn("Неожиданный формат ответа API:",{type:typeof e.data,isArray:Array.isArray(e.data),keys:e.data&&"object"==typeof e.data?Object.keys(e.data):"N/A",sample:JSON.stringify(e.data).substring(0,200)}),[]}catch(t){throw console.error("MobiMatter API Error (getProducts):",{message:t.message,response:t.response?.data,status:t.response?.status,statusText:t.response?.statusText}),Error(`Failed to fetch products: ${t.response?.data?.message||t.message}`)}}async getProduct(t){try{let e=await this.api.get(`/api/v2/products/${t}`);return e.data.product||e.data.data||e.data}catch(t){throw console.error("MobiMatter API Error (getProduct):",t.response?.data||t.message),Error(`Failed to fetch product: ${t.response?.data?.message||t.message}`)}}async createOrder(t,e){try{let r=await this.api.post("/api/v2/order",{productId:t,label:e?.label||`order_${Date.now()}`,...e}),a=r.data.order||r.data.data||r.data;return{id:a.orderId||a.id,orderId:a.orderId||a.id,productId:a.productId||t,status:a.status||"pending",qrCode:a.qrCode,activationCode:a.activationCode||a.smdpAddress,smdpAddress:a.smdpAddress,iccid:a.iccid,createdAt:a.createdAt||new Date().toISOString()}}catch(t){throw console.error("MobiMatter API Error (createOrder):",t.response?.data||t.message),Error(`Failed to create order: ${t.response?.data?.message||t.message}`)}}async getOrder(t){try{let e=await this.api.get(`/api/v2/order/${t}`),r=e.data.order||e.data.data||e.data;return{id:r.orderId||r.id||t,orderId:r.orderId||r.id||t,productId:r.productId,status:r.status,qrCode:r.qrCode,activationCode:r.activationCode||r.smdpAddress,smdpAddress:r.smdpAddress,iccid:r.iccid,createdAt:r.createdAt}}catch(t){throw console.error("MobiMatter API Error (getOrder):",t.response?.data||t.message),Error(`Failed to fetch order: ${t.response?.data?.message||t.message}`)}}async getOrders(t){try{let e=await this.api.get("/api/v2/orders",{params:t?{userId:t}:{}});if(Array.isArray(e.data))return e.data.map(t=>({id:t.orderId||t.id,orderId:t.orderId||t.id,productId:t.productId,status:t.status,qrCode:t.qrCode,activationCode:t.activationCode||t.smdpAddress,smdpAddress:t.smdpAddress,iccid:t.iccid,createdAt:t.createdAt}));if(e.data.orders&&Array.isArray(e.data.orders))return e.data.orders;if(e.data.data&&Array.isArray(e.data.data))return e.data.data;return[]}catch(t){throw console.error("MobiMatter API Error (getOrders):",t.response?.data||t.message),Error(`Failed to fetch orders: ${t.response?.data?.message||t.message}`)}}async getWalletBalance(){try{return(await this.api.get("/api/v2/wallet/balance")).data}catch(t){throw console.error("MobiMatter API Error (getWalletBalance):",t.response?.data||t.message),Error(`Failed to fetch wallet balance: ${t.response?.data?.message||t.message}`)}}async getCountries(){try{let t=await this.getProducts(),e=new Set;return t.forEach(t=>{t.countries&&Array.isArray(t.countries)&&t.countries.forEach(t=>{e.add(t)})}),Array.from(e).map(t=>({code:t,name:t,region:void 0}))}catch(t){throw console.error("Не удалось получить страны из продуктов:",t),t}}}let n=null;function d(){if(!n){let t=process.env.MOBIMATTER_MERCHANT_ID,e=process.env.MOBIMATTER_API_KEY;if(!t||!e)throw Error("MobiMatter credentials not configured. Please set MOBIMATTER_MERCHANT_ID and MOBIMATTER_API_KEY environment variables.");n=new i(t,e)}return n}a()}catch(t){a(t)}})},4123:(t,e,r)=>{r.a(t,async(t,a)=>{try{r.r(e),r.d(e,{default:()=>d});var s=r(2714),o=t([s]);async function d(t,e){if("POST"!==t.method)return e.status(405).json({error:"Method not allowed"});let{orderId:r,status:a,tariffId:o,userId:d}=t.body;if(!r)return e.status(400).json({error:"Missing orderId"});try{if(r)try{let t=(0,s.z)(),a=await t.getOrder(r);if("active"===a.status||"completed"===a.status)return e.status(200).json({success:!0,order:{id:a.id,status:a.status,qrCode:a.qrCode,activationCode:a.activationCode||a.smdpAddress,iccid:a.iccid}});return e.status(200).json({success:!0,order:{id:a.id,status:a.status}})}catch(t){console.error("MobiMatter API Error:",t.response?.data||t.message)}e.status(200).json({success:!0})}catch(t){console.error("Ошибка обработки callback:",t),e.status(500).json({error:"Ошибка обработки callback",details:t.message})}}s=(o.then?(await o)():o)[0],a()}catch(t){a(t)}})},7153:(t,e)=>{var r;Object.defineProperty(e,"x",{enumerable:!0,get:function(){return r}}),function(t){t.PAGES="PAGES",t.PAGES_API="PAGES_API",t.APP_PAGE="APP_PAGE",t.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(t,e,r)=>{t.exports=r(145)}};var e=require("../../../webpack-api-runtime.js");e.C(t);var r=e(e.s=8197);module.exports=r})();