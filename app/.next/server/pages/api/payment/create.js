"use strict";(()=>{var e={};e.id=561,e.ids=[561],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9648:e=>{e.exports=import("axios")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},9877:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{config:()=>u,default:()=>c,routeModule:()=>p});var s=r(1802),o=r(7153),d=r(6249),i=r(8076),n=e([i]);i=(n.then?(await n)():n)[0];let c=(0,d.l)(i,"default"),u=(0,d.l)(i,"config"),p=new s.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/payment/create",pathname:"/api/payment/create",bundlePath:"",filename:""},userland:i});a()}catch(e){a(e)}})},2714:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{z:()=>d});var s=r(9648),o=e([s]);s=(o.then?(await o)():o)[0];class i{constructor(e,t){this.merchantId=e,this.apiKey=t,this.api=s.default.create({baseURL:"https://api.mobimatter.com/mobimatter",headers:{merchantId:e,"api-key":t,"Content-Type":"application/json"}}),this.api.interceptors.request.use(e=>(console.log("MobiMatter API Request:",{method:e.method?.toUpperCase(),url:e.url,baseURL:e.baseURL}),e),e=>(console.error("MobiMatter API Request Error:",e),Promise.reject(e))),this.api.interceptors.response.use(e=>(console.log("MobiMatter API Response:",{status:e.status,url:e.config.url,dataLength:JSON.stringify(e.data).length}),e),e=>(console.error("MobiMatter API Response Error:",{status:e.response?.status,statusText:e.response?.statusText,url:e.config?.url,data:e.response?.data,message:e.message}),Promise.reject(e)))}async getProducts(e){try{let t=await this.api.get("/api/v2/products",{params:e}),r=typeof t.data,a=Array.isArray(t.data),s=t.data&&"object"==typeof t.data&&!Array.isArray(t.data)?Object.keys(t.data):[];if(console.log("MobiMatter getProducts response:",{status:t.status,dataType:r,isArray:a,keys:s.slice(0,10),dataLength:JSON.stringify(t.data).length,firstChars:JSON.stringify(t.data).substring(0,100)}),t.data.result&&Array.isArray(t.data.result))return console.log(`Получено ${t.data.result.length} продуктов (response.data.result)`),t.data.result;if(Array.isArray(t.data))return console.log(`Получено ${t.data.length} продуктов (массив)`),t.data;if(t.data.products&&Array.isArray(t.data.products))return console.log(`Получено ${t.data.products.length} продуктов (response.data.products)`),t.data.products;if(t.data.data&&Array.isArray(t.data.data))return console.log(`Получено ${t.data.data.length} продуктов (response.data.data)`),t.data.data;else return console.warn("Неожиданный формат ответа API:",{type:typeof t.data,isArray:Array.isArray(t.data),keys:t.data&&"object"==typeof t.data?Object.keys(t.data):"N/A",sample:JSON.stringify(t.data).substring(0,200)}),[]}catch(e){throw console.error("MobiMatter API Error (getProducts):",{message:e.message,response:e.response?.data,status:e.response?.status,statusText:e.response?.statusText}),Error(`Failed to fetch products: ${e.response?.data?.message||e.message}`)}}async getProduct(e){try{let t=await this.api.get(`/api/v2/products/${e}`);return t.data.product||t.data.data||t.data}catch(e){throw console.error("MobiMatter API Error (getProduct):",e.response?.data||e.message),Error(`Failed to fetch product: ${e.response?.data?.message||e.message}`)}}async createOrder(e,t){try{let r=await this.api.post("/api/v2/order",{productId:e,label:t?.label||`order_${Date.now()}`,...t}),a=r.data.order||r.data.data||r.data;return{id:a.orderId||a.id,orderId:a.orderId||a.id,productId:a.productId||e,status:a.status||"pending",qrCode:a.qrCode,activationCode:a.activationCode||a.smdpAddress,smdpAddress:a.smdpAddress,iccid:a.iccid,createdAt:a.createdAt||new Date().toISOString()}}catch(e){throw console.error("MobiMatter API Error (createOrder):",e.response?.data||e.message),Error(`Failed to create order: ${e.response?.data?.message||e.message}`)}}async getOrder(e){try{let t=await this.api.get(`/api/v2/order/${e}`),r=t.data.order||t.data.data||t.data;return{id:r.orderId||r.id||e,orderId:r.orderId||r.id||e,productId:r.productId,status:r.status,qrCode:r.qrCode,activationCode:r.activationCode||r.smdpAddress,smdpAddress:r.smdpAddress,iccid:r.iccid,createdAt:r.createdAt}}catch(e){throw console.error("MobiMatter API Error (getOrder):",e.response?.data||e.message),Error(`Failed to fetch order: ${e.response?.data?.message||e.message}`)}}async getOrders(e){try{let t=await this.api.get("/api/v2/orders",{params:e?{userId:e}:{}});if(Array.isArray(t.data))return t.data.map(e=>({id:e.orderId||e.id,orderId:e.orderId||e.id,productId:e.productId,status:e.status,qrCode:e.qrCode,activationCode:e.activationCode||e.smdpAddress,smdpAddress:e.smdpAddress,iccid:e.iccid,createdAt:e.createdAt}));if(t.data.orders&&Array.isArray(t.data.orders))return t.data.orders;if(t.data.data&&Array.isArray(t.data.data))return t.data.data;return[]}catch(e){throw console.error("MobiMatter API Error (getOrders):",e.response?.data||e.message),Error(`Failed to fetch orders: ${e.response?.data?.message||e.message}`)}}async getWalletBalance(){try{return(await this.api.get("/api/v2/wallet/balance")).data}catch(e){throw console.error("MobiMatter API Error (getWalletBalance):",e.response?.data||e.message),Error(`Failed to fetch wallet balance: ${e.response?.data?.message||e.message}`)}}async getCountries(){try{let e=await this.getProducts(),t=new Set;return e.forEach(e=>{e.countries&&Array.isArray(e.countries)&&e.countries.forEach(e=>{t.add(e)})}),Array.from(t).map(e=>({code:e,name:e,region:void 0}))}catch(e){throw console.error("Не удалось получить страны из продуктов:",e),e}}}let n=null;function d(){if(!n){let e=process.env.MOBIMATTER_MERCHANT_ID,t=process.env.MOBIMATTER_API_KEY;if(!e||!t)throw Error("MobiMatter credentials not configured. Please set MOBIMATTER_MERCHANT_ID and MOBIMATTER_API_KEY environment variables.");n=new i(e,t)}return n}a()}catch(e){a(e)}})},8076:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{default:()=>d});var s=r(2714),o=e([s]);async function d(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});let{tariffId:r,method:a,amount:o,userId:d}=e.body;if(!r)return t.status(400).json({error:"Missing tariffId"});try{try{let e=(0,s.z)(),o=await e.createOrder(r,{userId:d||"telegram_user",paymentMethod:a||"wallet"});if(o.id,o.qrCode,o.activationCode||o.smdpAddress,"active"===o.status||"completed"===o.status)return t.status(200).json({success:!0,orderId:o.id,qrCode:o.qrCode,activationCode:o.activationCode||o.smdpAddress,iccid:o.iccid,status:o.status,paymentUrl:null,paymentId:o.id});return t.status(200).json({success:!0,orderId:o.id,status:o.status,paymentUrl:null,paymentId:o.id})}catch(e){throw console.error("MobiMatter API Error:",e.response?.data||e.message),e}}catch(e){console.error("Ошибка создания платежа:",e),t.status(500).json({error:"Ошибка создания платежа",details:e.message})}}s=(o.then?(await o)():o)[0],a()}catch(e){a(e)}})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=9877);module.exports=r})();