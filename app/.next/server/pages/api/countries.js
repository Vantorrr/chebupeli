"use strict";(()=>{var e={};e.id=276,e.ids=[276],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9648:e=>{e.exports=import("axios")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},323:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{config:()=>l,default:()=>c,routeModule:()=>u});var s=r(1802),o=r(7153),d=r(6249),n=r(1352),i=e([n]);n=(i.then?(await i)():i)[0];let c=(0,d.l)(n,"default"),l=(0,d.l)(n,"config"),u=new s.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/countries",pathname:"/api/countries",bundlePath:"",filename:""},userland:n});a()}catch(e){a(e)}})},2714:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{z:()=>d});var s=r(9648),o=e([s]);s=(o.then?(await o)():o)[0];class n{constructor(e,t){this.merchantId=e,this.apiKey=t,this.api=s.default.create({baseURL:"https://api.mobimatter.com/mobimatter",headers:{merchantId:e,"api-key":t,"Content-Type":"application/json"}}),this.api.interceptors.request.use(e=>(console.log("MobiMatter API Request:",{method:e.method?.toUpperCase(),url:e.url,baseURL:e.baseURL}),e),e=>(console.error("MobiMatter API Request Error:",e),Promise.reject(e))),this.api.interceptors.response.use(e=>(console.log("MobiMatter API Response:",{status:e.status,url:e.config.url,dataLength:JSON.stringify(e.data).length}),e),e=>(console.error("MobiMatter API Response Error:",{status:e.response?.status,statusText:e.response?.statusText,url:e.config?.url,data:e.response?.data,message:e.message}),Promise.reject(e)))}async getProducts(e){try{let t=await this.api.get("/api/v2/products",{params:e}),r=typeof t.data,a=Array.isArray(t.data),s=t.data&&"object"==typeof t.data&&!Array.isArray(t.data)?Object.keys(t.data):[];if(console.log("MobiMatter getProducts response:",{status:t.status,dataType:r,isArray:a,keys:s.slice(0,10),dataLength:JSON.stringify(t.data).length,firstChars:JSON.stringify(t.data).substring(0,100)}),t.data.result&&Array.isArray(t.data.result))return console.log(`Получено ${t.data.result.length} продуктов (response.data.result)`),t.data.result;if(Array.isArray(t.data))return console.log(`Получено ${t.data.length} продуктов (массив)`),t.data;if(t.data.products&&Array.isArray(t.data.products))return console.log(`Получено ${t.data.products.length} продуктов (response.data.products)`),t.data.products;if(t.data.data&&Array.isArray(t.data.data))return console.log(`Получено ${t.data.data.length} продуктов (response.data.data)`),t.data.data;else return console.warn("Неожиданный формат ответа API:",{type:typeof t.data,isArray:Array.isArray(t.data),keys:t.data&&"object"==typeof t.data?Object.keys(t.data):"N/A",sample:JSON.stringify(t.data).substring(0,200)}),[]}catch(e){throw console.error("MobiMatter API Error (getProducts):",{message:e.message,response:e.response?.data,status:e.response?.status,statusText:e.response?.statusText}),Error(`Failed to fetch products: ${e.response?.data?.message||e.message}`)}}async getProduct(e){try{let t=await this.api.get(`/api/v2/products/${e}`);return t.data.product||t.data.data||t.data}catch(e){throw console.error("MobiMatter API Error (getProduct):",e.response?.data||e.message),Error(`Failed to fetch product: ${e.response?.data?.message||e.message}`)}}async createOrder(e,t){try{let r=await this.api.post("/api/v2/order",{productId:e,label:t?.label||`order_${Date.now()}`,...t}),a=r.data.order||r.data.data||r.data;return{id:a.orderId||a.id,orderId:a.orderId||a.id,productId:a.productId||e,status:a.status||"pending",qrCode:a.qrCode,activationCode:a.activationCode||a.smdpAddress,smdpAddress:a.smdpAddress,iccid:a.iccid,createdAt:a.createdAt||new Date().toISOString()}}catch(e){throw console.error("MobiMatter API Error (createOrder):",e.response?.data||e.message),Error(`Failed to create order: ${e.response?.data?.message||e.message}`)}}async getOrder(e){try{let t=await this.api.get(`/api/v2/order/${e}`),r=t.data.order||t.data.data||t.data;return{id:r.orderId||r.id||e,orderId:r.orderId||r.id||e,productId:r.productId,status:r.status,qrCode:r.qrCode,activationCode:r.activationCode||r.smdpAddress,smdpAddress:r.smdpAddress,iccid:r.iccid,createdAt:r.createdAt}}catch(e){throw console.error("MobiMatter API Error (getOrder):",e.response?.data||e.message),Error(`Failed to fetch order: ${e.response?.data?.message||e.message}`)}}async getOrders(e){try{let t=await this.api.get("/api/v2/orders",{params:e?{userId:e}:{}});if(Array.isArray(t.data))return t.data.map(e=>({id:e.orderId||e.id,orderId:e.orderId||e.id,productId:e.productId,status:e.status,qrCode:e.qrCode,activationCode:e.activationCode||e.smdpAddress,smdpAddress:e.smdpAddress,iccid:e.iccid,createdAt:e.createdAt}));if(t.data.orders&&Array.isArray(t.data.orders))return t.data.orders;if(t.data.data&&Array.isArray(t.data.data))return t.data.data;return[]}catch(e){throw console.error("MobiMatter API Error (getOrders):",e.response?.data||e.message),Error(`Failed to fetch orders: ${e.response?.data?.message||e.message}`)}}async getWalletBalance(){try{return(await this.api.get("/api/v2/wallet/balance")).data}catch(e){throw console.error("MobiMatter API Error (getWalletBalance):",e.response?.data||e.message),Error(`Failed to fetch wallet balance: ${e.response?.data?.message||e.message}`)}}async getCountries(){try{let e=await this.getProducts(),t=new Set;return e.forEach(e=>{e.countries&&Array.isArray(e.countries)&&e.countries.forEach(e=>{t.add(e)})}),Array.from(t).map(e=>({code:e,name:e,region:void 0}))}catch(e){throw console.error("Не удалось получить страны из продуктов:",e),e}}}let i=null;function d(){if(!i){let e=process.env.MOBIMATTER_MERCHANT_ID,t=process.env.MOBIMATTER_API_KEY;if(!e||!t)throw Error("MobiMatter credentials not configured. Please set MOBIMATTER_MERCHANT_ID and MOBIMATTER_API_KEY environment variables.");i=new n(e,t)}return i}a()}catch(e){a(e)}})},1352:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{default:()=>d});var s=r(2714),o=e([s]);s=(o.then?(await o)():o)[0];let n={TH:"Таиланд",NL:"Нидерланды",TR:"Турция",AE:"ОАЭ",EG:"Египет",ES:"Испания",IT:"Италия",GR:"Греция",JP:"Япония",SG:"Сингапур",MV:"Мальдивы",MA:"Марокко",US:"США",GB:"Великобритания",FR:"Франция",DE:"Германия",CN:"Китай",IN:"Индия",BR:"Бразилия",AU:"Австралия",ID:"Индонезия",MY:"Малайзия",PH:"Филиппины",VN:"Вьетнам",KR:"Южная Корея",PT:"Португалия",PL:"Польша",CZ:"Чехия",AT:"Австрия",CH:"Швейцария",GH:"Гана",VE:"Венесуэла",GL:"Гренландия"},i={TH:"Азия",NL:"Европа",TR:"Европа",AE:"Ближний Восток",EG:"Африка",ES:"Европа",IT:"Европа",GR:"Европа",JP:"Азия",SG:"Азия",MV:"Азия",MA:"Африка",US:"Северная Америка",GB:"Европа",FR:"Европа",DE:"Европа",CN:"Азия",IN:"Азия",BR:"Южная Америка",AU:"Океания",ID:"Азия",MY:"Азия",PH:"Азия",VN:"Азия",KR:"Азия",PT:"Европа",PL:"Европа",CZ:"Европа",AT:"Европа",CH:"Европа",GH:"Африка",VE:"Южная Америка",GL:"Северная Америка"};async function d(e,t){if("GET"!==e.method)return t.status(405).json({error:"Method not allowed"});try{void 0===global.countriesCache&&(global.countriesCache={data:null,timestamp:0});let e=global.countriesCache,r=Date.now();if(e.data&&r-e.timestamp<3e5)return console.log("Используем кешированные данные стран"),t.status(200).json({countries:e.data});let a=[];try{let t=(0,s.z)();console.log("Запрос продуктов из MobiMatter API...");let r=await t.getProducts();if(console.log(`Получено ${r.length} продуктов`),0===r.length)throw console.warn("API вернул 0 продуктов, используем моковые данные"),Error("No products returned from API");if(r.length>0){let e=r[0],t=e.productDetails?.find(e=>"EXTERNALLY_SHOWN"===e.name);console.log("Пример продукта:",{productCategory:e.productCategory,EXTERNALLY_SHOWN:t?.value,countries:e.countries,wholesalePrice:e.wholesalePrice,hasProductDetails:!!e.productDetails})}let o=r.filter(e=>{let t="esim_realtime"===e.productCategory,r=!1;if(e.productDetails&&Array.isArray(e.productDetails)){let t=e.productDetails.find(e=>"EXTERNALLY_SHOWN"===e.name);r=t&&("1"===t.value||1===t.value)}return t&&r});console.log(`Отфильтровано ${o.length} реальных продуктов из ${r.length}`);let d={},c={},l=new Set;o.forEach(e=>{if(e.countries&&Array.isArray(e.countries)&&e.countries.length>0){let t=e.countries.length,r="local";1===t?r="local":t>=2&&t<=10?r="regional":t>10&&(r="international"),e.countries.forEach(t=>{if(t&&2===t.length&&(l.add(t),e.wholesalePrice)){let a=parseFloat(process.env.TARIFF_MARGIN||"1.0"),s=e.wholesalePrice*(1+a);d[t]&&!(s<d[t])||(d[t]=s,"local"!==r&&c[t]||(c[t]=r))}})}}),console.log(`Найдено ${l.size} уникальных стран`),(a=Array.from(l).map(e=>({code:e,name:n[e]||e,region:i[e]||"Другое",minPrice:d[e],type:c[e]||"local"}))).sort((e,t)=>{let r={local:0,regional:1,international:2},a=(r[e.type||"local"]||0)-(r[t.type||"local"]||0);return 0!==a?a:(e.minPrice||0)-(t.minPrice||0)}),console.log(`Сформировано ${a.length} стран`),e.data=a,e.timestamp=Date.now()}catch(e){console.error("MobiMatter API Error:",{message:e.message,response:e.response?.data,status:e.response?.status,stack:e.stack}),console.warn("Используем моковые данные из-за ошибки API"),a=[{code:"TH",name:"Таиланд",region:"Азия",minPrice:4},{code:"NL",name:"Нидерланды",region:"Европа",minPrice:4},{code:"TR",name:"Турция",region:"Европа",minPrice:5},{code:"AE",name:"ОАЭ",region:"Ближний Восток",minPrice:6},{code:"EG",name:"Египет",region:"Африка",minPrice:7},{code:"ES",name:"Испания",region:"Европа",minPrice:4.5},{code:"IT",name:"Италия",region:"Европа",minPrice:4.5},{code:"GR",name:"Греция",region:"Европа",minPrice:5}]}t.status(200).json({countries:a})}catch(e){console.error("Ошибка загрузки стран:",e),t.status(500).json({error:"Ошибка загрузки стран",details:e.message})}}a()}catch(e){a(e)}})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=323);module.exports=r})();